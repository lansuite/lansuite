"use strict";(self.webpackChunklansuite_documentation=self.webpackChunklansuite_documentation||[]).push([[605],{3905:(e,t,n)=>{n.d(t,{Zo:()=>d,kt:()=>m});var a=n(7294);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function c(e,t){if(null==e)return{};var n,a,i=function(e,t){if(null==e)return{};var n,a,i={},r=Object.keys(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(a=0;a<r.length;a++)n=r[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var l=a.createContext({}),s=function(e){var t=a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},d=function(e){var t=s(e.components);return a.createElement(l.Provider,{value:t},e.children)},u="mdxType",h={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},p=a.forwardRef((function(e,t){var n=e.components,i=e.mdxType,r=e.originalType,l=e.parentName,d=c(e,["components","mdxType","originalType","parentName"]),u=s(n),p=i,m=u["".concat(l,".").concat(p)]||u[p]||h[p]||r;return n?a.createElement(m,o(o({ref:t},d),{},{components:n})):a.createElement(m,o({ref:t},d))}));function m(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var r=n.length,o=new Array(r);o[0]=p;var c={};for(var l in t)hasOwnProperty.call(t,l)&&(c[l]=t[l]);c.originalType=e,c[u]="string"==typeof e?e:i,o[1]=c;for(var s=2;s<r;s++)o[s]=n[s];return a.createElement.apply(null,o)}return a.createElement.apply(null,n)}p.displayName="MDXCreateElement"},522:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>o,default:()=>h,frontMatter:()=>r,metadata:()=>c,toc:()=>s});var a=n(7462),i=(n(7294),n(3905));const r={id:"cache",title:"Using the LANSuite cache",sidebar_position:2},o=void 0,c={unversionedId:"development/cache",id:"development/cache",title:"Using the LANSuite cache",description:"Introduction",source:"@site/docs/development/cache.md",sourceDirName:"development",slug:"/development/cache",permalink:"/lansuite/docs/development/cache",draft:!1,editUrl:"https://github.com/lansuite/lansuite/tree/master/website/docs/development/cache.md",tags:[],version:"current",sidebarPosition:2,frontMatter:{id:"cache",title:"Using the LANSuite cache",sidebar_position:2},sidebar:"documentationSidebar",previous:{title:"Generating API docs",permalink:"/lansuite/docs/development/api-docs"},next:{title:"Coding style guide",permalink:"/lansuite/docs/development/coding-style-guide"}},l={},s=[{value:"Introduction",id:"introduction",level:2},{value:"Usage",id:"usage",level:2},{value:"Architecture",id:"architecture",level:3},{value:"Code",id:"code",level:3},{value:"Naming convention",id:"naming-convention",level:3},{value:"Pitfalls",id:"pitfalls",level:2},{value:"Race conditions",id:"race-conditions",level:3},{value:"Cache Item Timeout",id:"cache-item-timeout",level:3},{value:"Cached display",id:"cached-display",level:3}],d={toc:s},u="wrapper";function h(e){let{components:t,...n}=e;return(0,i.kt)(u,(0,a.Z)({},d,n,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h2",{id:"introduction"},"Introduction"),(0,i.kt)("p",null,"In order to avoid unnecessary calculations of unchanged data or retrieval from slow sources LanSuite now uses an internal caching infrastructure.\nWhen you are implementing new features it should be considered if content needs to be created on every call or if content can be cached and reused.\nAlso for the usage this has some implications as the content on some pages may not represent the latest state, but the cached content."),(0,i.kt)("h2",{id:"usage"},"Usage"),(0,i.kt)("h3",{id:"architecture"},"Architecture"),(0,i.kt)("p",null,'Think where data needs to be processed on call and where it requires processing on change.\nE.g. A user is set to "paid" for the next party. This means that the amount of guests increases by one.\nEither the total number of guests is recalculated on every page display again, or this is updated once the amount changes by user payment.\nThe more efficient variant is the later one, as the case appears far less than just page displays.\nAlso there is no requirement that the value is always correct, as it is just used for display.'),(0,i.kt)("h3",{id:"code"},"Code"),(0,i.kt)("p",null,"There is object named ",(0,i.kt)("inlineCode",{parentName:"p"},"$cache")," available in the global scope.\nThis implements ",(0,i.kt)("a",{parentName:"p",href:"https://www.php-fig.org/psr/psr-16/"},"PSR-16")," and either works via APCu (if module enabled) or with files in the temporary directory.\nCode example:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-php"},"// Import global object\nglobal $cache;\n\n// Try to get cache-item\n$cachedItem = $cache->getItem('module.entry.id');\nif (!$cachedItem->isHit()) {\n    // Not in cache, thus generate content\n    $cacheData = expensiveFunction();\n    // Write back to item and cache\n    $cachedItem->set($cacheData,<TTL>);\n    $cache->save($cachedItem);\n    }\n$Data = $cachedItem->get();\n//Run processing of data in $Data\n...\n")),(0,i.kt)("h3",{id:"naming-convention"},"Naming convention"),(0,i.kt)("p",null,"Cache entries should be named based on the following schema:\n",(0,i.kt)("inlineCode",{parentName:"p"},"<module>.<entry>.<identificator>"),"\ne.g. ",(0,i.kt)("inlineCode",{parentName:"p"},"discord.cache"),", ",(0,i.kt)("inlineCode",{parentName:"p"},"forum.thread.32121")," or ",(0,i.kt)("inlineCode",{parentName:"p"},"translation.de.board"),".\nFurther levels below this are possible and left to the discretion of the developer."),(0,i.kt)("h2",{id:"pitfalls"},"Pitfalls"),(0,i.kt)("h3",{id:"race-conditions"},"Race conditions"),(0,i.kt)("p",null,"As the cache provides a single instance across parallel executions, it can happen that multiple threads access an entry at the same or close to the same time.\nThis could cause a cache entry to be updated multiple times, because an update already occured between ",(0,i.kt)("inlineCode",{parentName:"p"},"$cache->getItem()")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"$cache->write()"),"\nThis can be a problem on high-load servers on restarts or cache misses, because this could cause a massive ammount of recalculations.\nThis would need a better implementation that includes cache mutexes."),(0,i.kt)("h3",{id:"cache-item-timeout"},"Cache Item Timeout"),(0,i.kt)("p",null,"Entries have a default Time-To-Live of ten minutes and disappear after that.\nA cache entry could disappear between the check in ",(0,i.kt)("inlineCode",{parentName:"p"},"$cache->getItem()")," and retrieval if the TTL is breached between these two calls.\nThis can be influenced by defining a custom TTL when writing the item back."),(0,i.kt)("h3",{id:"cached-display"},"Cached display"),(0,i.kt)("p",null,"Please remember that while developing your software with cache usage you may see stale data when displaying a page.\nIt would be recommended to either:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"reduce the TTL to one second"),(0,i.kt)("li",{parentName:"ul"},"overwrite $cache with an instance of ",(0,i.kt)("inlineCode",{parentName:"li"},"NullCache")," as that practically disables the cache."),(0,i.kt)("li",{parentName:"ul"},"include a call to ",(0,i.kt)("inlineCode",{parentName:"li"},"$cache->clear()")," to ensure that no old entries are in the cache")))}h.isMDXComponent=!0}}]);